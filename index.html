<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Temperatura</title>
    <style>
        /* Estilos mejorados */
        .tabcontent {
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s;
        }
        
        .tabcontent.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .temp-actual {
            background: #3498db;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 24px;
        }
        
        #grafico {
            max-height: 500px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'monitor')" id="defaultTab">Monitor</button>
            <button class="tablinks" onclick="openTab(event, 'alertas')">Alertas</button>
            <button class="tablinks" onclick="openTab(event, 'config')">Configuración</button>
        </div>

        <!-- Pestaña Monitor -->
        <div id="monitor" class="tabcontent">
            <div class="temp-actual" id="tempActual">
                Cargando...
            </div>
            <canvas id="grafico"></canvas>
        </div>

        <!-- Pestaña Alertas -->
        <div id="alertas" class="tabcontent">
            <h2>Historial de Alertas</h2>
            <div id="listaAlertas"></div>
        </div>

        <!-- Pestaña Configuración -->
        <div id="config" class="tabcontent">
            <h2>Configurar Umbral</h2>
            <input type="number" id="umbralInput" placeholder="Ej: 30">
            <button onclick="guardarUmbral()">Guardar</button>
        </div>
    </div>

    <script>
        const socket = io();
        let chart;

        // Función para cambiar pestañas
        function openTab(evt, tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tabcontent').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remover clase active de los botones
            document.querySelectorAll('.tablinks').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar contenido seleccionado
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // Inicializar gráfico
        async function initChart() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                const ctx = document.getElementById('grafico').getContext('2d');
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.timestamp).toLocaleString()),
                        datasets: [{
                            label: 'Temperatura (°C)',
                            data: data.map(d => d.valor),
                            borderColor: '#3498db',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Actualizar temperatura actual
                if(data.length > 0) {
                    document.getElementById('tempActual').textContent = 
                        `${data[data.length - 1].valor} °C`;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Actualizar en tiempo real
        socket.on('nueva_temperatura', (data) => {
            // Actualizar cuadro de temperatura
            document.getElementById('tempActual').textContent = 
                `${data.valor} °C`;
            
            // Actualizar gráfico
            if(chart) {
                chart.data.labels.push(new Date(data.timestamp).toLocaleString());
                chart.data.datasets[0].data.push(data.valor);
                chart.update();
            }
        });

        // Configurar umbral
        async function guardarUmbral() {
            const umbral = document.getElementById('umbralInput').value;
            try {
                await fetch('/api/umbral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ umbral })
                });
                alert('Umbral actualizado correctamente');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            // Activar pestaña por defecto
            document.getElementById('defaultTab').click();
            initChart();
            
            // Cargar alertas iniciales
            fetch('/api/alertas')
                .then(res => res.json())
                .then(data => {
                    const lista = data.map(alerta => `
                        <div style="padding: 10px; border-bottom: 1px solid #ccc;">
                            ${new Date(alerta.timestamp).toLocaleString()} - 
                            ${alerta.valor}°C (Umbral: ${alerta.threshold}°C)
                        </div>
                    `).join('');
                    document.getElementById('listaAlertas').innerHTML = lista;
                });
        });
    </script>
</body>
</html>
